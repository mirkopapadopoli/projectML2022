```{r}
#import library
library(e1071)
library(ggplot2)
library(dplyr)
library(Hmisc)
library(corrplot)
```

```{r}
#import csv
card.trans_data_tot = read.csv("card_transdata.csv")
```

```{r}
set.seed(33)
card.trans_data = card.trans_data_tot[sample(1:nrow(card.trans_data_tot), nrow(card.trans_data_tot)/100),]
```

```{r}
#conversion dataset
card.trans_data$repeat_retailer = factor(card.trans_data$repeat_retailer)
card.trans_data$used_chip = factor(card.trans_data$used_chip)
card.trans_data$used_pin_number = factor(card.trans_data$used_pin_number)
card.trans_data$online_order = factor(card.trans_data$online_order)
card.trans_data$fraud = factor(card.trans_data$fraud)
```

```{r}
head(card.trans_data)
```

```{r}
card.trans_data %>%
  filter( distance_from_home<max(distance_from_home) ) %>%
  ggplot( aes(x=distance_from_home)) +
    geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)
```

```{r}
card.trans_data %>%
  filter( distance_from_last_transaction<max(distance_from_last_transaction) ) %>%
  ggplot( aes(x=distance_from_last_transaction)) +
    geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)
```

```{r}
card.trans_data %>%
  filter( ratio_to_median_purchase_price<max(ratio_to_median_purchase_price) ) %>%
  ggplot( aes(x=ratio_to_median_purchase_price)) +
    geom_density(fill="#69b3a2", color="#e9ecef", alpha=0.8)
```

```{r}
ggplot(data.frame(card.trans_data$repeat_retailer), aes(x=card.trans_data$repeat_retailer)) +
  geom_bar()
```

```{r}
  ggplot(data.frame(card.trans_data$used_chip), aes(x=card.trans_data$used_chip)) +
  geom_bar()
```

```{r}
ggplot(data.frame(card.trans_data$used_pin_number), aes(x=card.trans_data$used_pin_number)) +
  geom_bar()
```

```{r}
ggplot(data.frame(card.trans_data$online_order), aes(x=card.trans_data$online_order)) +
  geom_bar()
```

```{r}
ggplot(data.frame(card.trans_data$fraud), aes(x=card.trans_data$fraud)) +
  geom_bar()
```

```{r}
#sistemare ggploot
sub <- subset(card.trans_data, select = c(distance_from_home, distance_from_last_transaction, ratio_to_median_purchase_price))

card.trans_data %>%
  filter( ratio_to_median_purchase_price < max(ratio_to_median_purchase_price) ) %>%
  ggplot(sub, aes(x=sub, y=len)) + 
  geom_boxplot()
```

```{r}
describe(card.trans_data)
```

```{r}
#camviare sizes
sizes <- c(35044,10000)
labels <- c("No Fraud","Fraud")

ggplot(data=NULL, aes(x=labels, y=sizes, fill=labels)) +
  geom_bar(stat="identity") +
  labs(title="What Percentage of Transactions Using Chip and Password are Fraud Transactions?", fill="") +
  theme(legend.position="none")
```

```{r}
#preprocessing se duplicati e nulli
s = duplicated(card.trans_data)
sum(s)
sum(is.na(card.trans_data))
```

```{r}
#scatter matrix tra var continue
my_cols <- c("#00AFBB", "#E7B800", "#FC4E07")  
pairs(card.trans_data[,1:3], pch = 19,  cex = 0.5,
      col = my_cols[card.trans_data$fraud],
      lower.panel=NULL)
```

```{r}
#corr matrix
card.cor = cor(card.trans_data[,1:3])
corrplot(card.cor)
```

```{r}
#relazione se è frode usando torta
sub.fraud = card.trans_data[which(card.trans_data$fraud == 1),]
sub.nrow = nrow(sub.fraud)
for(i in 4:7){
  sub.zero = length(sub.fraud[which(sub.fraud[,i] == 0), i])
  sub.one = sub.nrow - sub.zero
  slices <- c(sub.zero, sub.one)
  lbls <- c("non c'e'", "c'e'")
  pct <- round(slices/sum(slices)*100)
  lbls <- paste(lbls, pct) # add percents to labels
  lbls <- paste(lbls,"%",sep="") # ad % to labels
  pie(slices,labels = lbls, col=rainbow(length(lbls)),
   main=colnames(card.trans_data)[i])
}
#se c'è stata una frode, sicuramente è perché non c'era il pin
```

```{r}
sub.nofraud = card.trans_data[which(card.trans_data$fraud == 0),]
sub.nonrow = nrow(sub.nofraud)
for(i in 4:7){
  sub.zero = length(sub.nofraud[which(sub.nofraud[,i] == 0), i])
  sub.one = sub.nonrow - sub.zero
  slices <- c(sub.zero, sub.one)
  lbls <- c("non c'e'", "c'e'")
  pct <- round(slices/sum(slices)*100)
  lbls <- paste(lbls, pct) # add percents to labels
  lbls <- paste(lbls,"%",sep="") # ad % to labels
  pie(slices,labels = lbls, col=rainbow(length(lbls)),
   main=colnames(card.trans_data)[i])
}
```

```{r}
quantile.cast <- function(column){
  max = summary(column)[[6]]
  first_q = summary(column)[[2]]
  second_q = summary(column)[[3]]
  third_q = summary(column)[[5]]
  
  q = c(first_q, second_q, third_q, max)
  tmp_col = rep(0, length(column))
  
  for(i in c(1:3)){
    indexes = which(column > q[i] && column <= q[i+1])
    tmp_col[indexes] = i
  }
  
  return(tmp_col)
}
```

```{r}
for(i in (1:3)){
  qc = quantile.cast(card.trans_data[,i])
  qcf = factor(qc, levels = c(0, 1, 2, 3))
  card.trans_data[paste(colnames(card.trans_data)[i], "_discrete")] = qcf
}
```

```{r}
split.data = function(data, p = 0.7, s = 1){
set.seed(s)
index = sample(1:dim(data)[1])
train = data[index[1:floor(dim(data)[1] * p)], ]
test = data[index[((ceiling(dim(data)[1] * p)) + 1):dim(data)[1]], ]
return(list(train=train, test=test)) } 
```

```{r}
for (i in c(1:20)) {
  allset= split.data(card.trans_data, s = i)
  
}
```

```{r}

```
